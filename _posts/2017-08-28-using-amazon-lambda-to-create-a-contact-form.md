---
layout: post
title: "Using Amazon Lambda to create a contact form"
date: 2017-08-28 01:07:23 UTC
excerpt: " While Hurricane Harvey rains down on Texas I decided this would be a prefect time to build a contact form for a static HTML page that I need. At first I looked at services like FormKeep to send emails but I felt like it w..."
---

 <p>While <a href="https://www.nytimes.com/2017/08/26/us/hurricane-harvey-texas.html?mcubz=1">Hurricane Harvey</a> rains down on Texas I decided this would be a prefect time to build a contact form for a static HTML page that I need. At first I looked at services like <a href="https://formkeep.com/">FormKeep</a> to send emails but I felt like it was too expensive (starting $59 a month). And it was probably overkill.</p><p>I need a simple endpoint I can post data to and kick off an email to me. We’re going to build exactly that with Amazon Lambda, <a href="https://www.nodemailer.com">nodemailer</a>, and <a href="https://sendgrid.com/">Send Grid</a>.</p><h3>Getting Amazon setup</h3><p>This probably will be the trickiest part of this tutorial since Amazons UI is a bit clunky. To summarize what we need to get done before writing any JavaScript:</p><ul><li>Create API gateway endpoint</li><li>Create Lambda function</li><li>Setup POST requests to route to Lambda function</li><li>Set up deploy environment (to get API URL)</li></ul><h4>Create API gateway endpoint</h4><p>Navigate to Amazon API Gateway and click the “Get started” button. Select “New API” radio box (not “Example API” which is checked by default) and fill in the name of the API. Click “Create API”.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*_EjZ41hXFr_l7ruLLLcYQA.png" /><figcaption>Example image of Amazon API Gateway create screen</figcaption></figure><p>On the next screen click the actions button and select “Create Method” from the dropdown. Then select “POST” from the dropdown in the the the pane.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*tBNvo5SE4TqEZB-Rfv_FOA.gif" /><figcaption>Animated GIF setting up POST endpoint</figcaption></figure><p>Now you should see a new card in the right pane titled “POST”. We need to setup what the API does when it receives this POST request. It should route to the lambda function we’re going to write.</p><h4>Create Amazon Lambda Function</h4><p>We’re going to use <a href="https://serverless.com/framework/">Serverless</a> to help manage and deploy our Lambda function. First, we should install the serverless NPM package:</p><pre>npm i -g serverless</pre><p>Next, follow the <a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/">serverless docs on setting up your AWS credentials</a>. Their documentation is pretty thorough. This will allow you to create lambda functions from the command line</p><p>After you get your credentials setup we’re going to create our lambda function:</p><pre>serverless create --template aws-nodejs --path contact-lambda<br>cd contact-lambda<br>serverless deploy</pre><p>This will create a lambda function with AWS and scaffold the project. This is an AWESOME time saver!</p><h4>Setup POST requests to route to Lambda function</h4><p>Navigate back to your API endpoints resources page and click the title “POST”. Click “Setup up now”. Select “Lambda Function” for Integration type and the region you created your function. Then type in the name of the Lambda function you just created in the last step.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*GoZpgvbj-GsDumS2mCsrJg.gif" /></figure><h4>Setup a deploy environment</h4><p>From the Resources page inside API Gateway click the “Actions” button and select “Deploy API” from the dropdown. Inside of the modal that pops up select “new stage” and name it whatever you would like. Fill in any details you would like and click “Deploy”.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*MfSy_tnnbUPKSOHoZSct-w.gif" /><figcaption>Deploy the API</figcaption></figure><p>This will give you a URL that you can POST to and send data to the Lambda function.</p><pre>https://[example].execute-api.us-east-1.amazonaws.com/prod</pre><p>That’s it! We’ve setup everything we need on AWS for now. To summarize we:</p><ul><li>Created an API endpoint</li><li>Pointed POST requests to our Lambda function</li><li>Deployed the API</li></ul><h3>The code</h3><p>Since I want to use the <a href="https://github.com/tc39/proposal-object-rest-spread">object spread operator</a> and we can only use Node 6.10, we’re going to need to setup webpack. We’ll use babel to polyfill the missing features. Let’s install the needed dependencies:</p><pre>yarn add -D babel-core babel-loader babel-preset-stage-2 babel-preset-es2015 dotenv nodemailer nodemailer-sendgrid-transport serverless-webpack webpack</pre><p>Create a webpack.config.js file in the project root:</p><pre>module.exports = {<br>  entry: &#39;./handler.js&#39;,<br>  target: &#39;node&#39;,<br>  module: {<br>    rules: [<br>      {<br>        test: /\.js$/,<br>        exclude: /(node_modules|bower_components)/,<br>        use: {<br>          loader: &#39;babel-loader&#39;,<br>          options: {<br>            presets: [&#39;es2015&#39;, &#39;stage-2&#39;]<br>          }<br>        }<br>      }<br>    ]<br>  }<br>};</pre><p>And modify the serverless.yml file to add our webpack plugin:</p><pre>provider:<br>  name: aws<br>  runtime: nodejs6.10<br>plugins:<br>  - serverless-webpack</pre><pre>....</pre><h4>Setting up the mailer</h4><p>Let’s dig into some JavaScript and set up nodemailer with Send Grid. First, we need to initialize dotenv to keep the Send Grid API key out of source control.</p><pre>&#39;use strict&#39;;</pre><pre>require(&#39;dotenv&#39;).config();</pre><pre>module.exports.hello = (email, context, callback) =&gt; {<br>  // TODO<br>};</pre><p>And then create a .env file in the project root with your API key:</p><pre>API_KEY=[YOUR_KEY]</pre><p>Next, we can setup nodemailer. Require nodemailer and Send Grid transport dependencies:</p><pre>&#39;use strict&#39;;<br>require(&#39;dotenv&#39;).config();<br>const nodemailer = require(&#39;nodemailer&#39;);<br>const sgTransport = require(&#39;nodemailer-sendgrid-transport&#39;);</pre><p>We’re going to create an options object that has a nested auth object with the Send Gridapi_key. <a href="https://sendgrid.com/docs/Classroom/Send/How_Emails_Are_Sent/api_keys.html">This is a great resource for learning how to generate an API key for send grid.</a></p><p>Then we can create our nodemailer transport class by passing it the sgTransport function with our options object.</p><pre>&#39;use strict&#39;;<br>require(&#39;dotenv&#39;).config();<br>const nodemailer = require(&#39;nodemailer&#39;);<br>const sgTransport = require(&#39;nodemailer-sendgrid-transport&#39;);</pre><pre>const options = {<br>  auth: {<br>    api_key: process.env.API_KEY<br>  }<br>};</pre><pre>const client = nodemailer.createTransport(sgTransport(options));</pre><pre>module.exports.hello = (email, context, callback) =&gt; {<br>  // TODO<br>};</pre><p>Now that the transporter has been created we can send an email. Inside of the hello function, we’re going to create a variable called mailOptions. This variable will hold the data of the email like who it’s from, where its going, the subject, and body. Here’s a list of <a href="https://nodemailer.com/message/#commmon-fields">valid nodemailer options</a>.</p><p>The first argument to our lambda function is the data that is sent to the API. For my use case, I’m going to always send the email to one person. So I’ll hard code the to key to my email. Then spread the email object onto our mailOptions object.</p><pre>&#39;use strict&#39;;<br>require(&#39;dotenv&#39;).config();<br>const nodemailer = require(&#39;nodemailer&#39;);<br>const sgTransport = require(&#39;nodemailer-sendgrid-transport&#39;);</pre><pre>const options = {<br>  auth: {<br>    api_key: process.env.API_KEY<br>  }<br>};</pre><pre>const client = nodemailer.createTransport(sgTransport(options));</pre><pre>module.exports.hello = (email, context, callback) =&gt; {<br>  // setup email data<br>  let mailOptions = {<br>    to: &#39;youremail@example.com&#39;,<br>    ...email<br>  };<br>};</pre><p>Now that we’ve constructed the data of the email we can send it using the transporter we instantiated earlier.</p><pre>&#39;use strict&#39;;<br>require(&#39;dotenv&#39;).config();<br>const nodemailer = require(&#39;nodemailer&#39;);<br>const sgTransport = require(&#39;nodemailer-sendgrid-transport&#39;);</pre><pre>const options = {<br>  auth: {<br>    api_key: process.env.API_KEY<br>  }<br>};</pre><pre>const client = nodemailer.createTransport(sgTransport(options));</pre><pre>module.exports.hello = (email, context, callback) =&gt; {<br>  // setup email data<br>  let mailOptions = {<br>    to: &#39;youremail@example.com&#39;,<br>    ...email<br>  };</pre><pre>  // send mail with defined transport object<br>  client.sendMail(mailOptions, (error, info) =&gt; {<br>    if (error) {<br>      throw new Error(error);<br>    }</pre><pre>    const response = {<br>      statusCode: 200,<br>      body: JSON.stringify({<br>        ...info<br>      })<br>    };</pre><pre>    callback(null, response);<br>  });<br>};</pre><p>If there was an error we’ll throw and if it succeeds we’ll create a response object and spread the response from send grid onto it.</p><p>Bam! That’s all we need to do to send emails from a lambda function. Let’s deploy these changes:</p><pre>serverless deploy</pre><h3>Example use</h3><p>How do you use this thing? It’s simple now! If we were to use fetch, our POST request might look something like:</p><pre>fetch(&#39;https://[yoururl].execute-api.us-east-2.amazonaws.com/[yourstage]&#39;, {<br>  method: &quot;POST&quot;,<br>  body: JSON.stringify({<br>    &quot;from&quot;: &#39;email@example.com&#39;, // sender address<br>    &quot;subject&quot;:`New Contact: fromemail@example.com`, // Subject line<br>    &quot;text&quot;: &#39;New contact from: fromemail@example.com \n Hello world!&#39;<br>  }),</pre><pre>  headers: {<br>    &#39;Accept&#39;: &#39;application/json&#39;,<br>    &#39;Content-Type&#39;: &#39;application/json&#39;<br>  }<br>});</pre><p>This would send an email from email@example.com with the title New Contact: email@example.com and the body of:</p><pre>New contact from: email@example.com<br>Hello world!</pre><p>That’s it! You can now send POST requests to the API endpoint you setup and send emails. This works great if you’re looking to have a simple contact form on a static site.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=a41b192fae84" width="1" height="1" alt="">