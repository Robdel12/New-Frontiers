---
import BaseLayout from '../layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'

let posts = await getCollection('posts')
posts = posts.sort((a, b) => new Date(b.data.date) - new Date(a.data.date))
---

<BaseLayout title="Blog">
  <div class="blog-list">
    <h1>Blog Posts</h1>
    <div class="post-list">
      {
        posts.map((post) => {
          let date = new Date(post.data.date)
          let year = date.getFullYear()
          let month = String(date.getMonth() + 1).padStart(2, '0')
          let day = String(date.getDate()).padStart(2, '0')
          let cleanSlug = post.slug.replace(/^\d{4}-\d{2}-\d{2}-/, '')
          let url = `/${year}/${month}/${day}/${cleanSlug}`

          return (
            <article class="post-item">
              <div class="post-header">
                <time class="post-date" datetime={post.data.date.toISOString()}>
                  {date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                  })}
                </time>
                <h2>
                  <a class="post-title-link" href={url}>
                    {post.data.title}
                  </a>
                </h2>
              </div>
              {post.data.excerpt ? (
                <p class="post-excerpt">{post.data.excerpt}</p>
              ) : (
                <p class="post-excerpt post-excerpt-generated">
                  {post.body
                    .replace(/^---[\s\S]*?---\n?/, '')
                    .replace(/```[\s\S]*?```/g, '')
                    .replace(/<iframe[\s\S]*?<\/iframe>/gi, '')
                    .replace(/<[^>]*>/g, '')
                    .replace(/\n+/g, ' ')
                    .trim()
                    .substring(0, 200)}
                  ...
                </p>
              )}
            </article>
          )
        })
      }
    </div>
  </div>
</BaseLayout>
