---
layout: post
title: 'Tutorial: Visual testing for Gatsby and Netlify with Percy'
date: 2020-02-13
excerpt: ' As one of the most popular “static site” generators, the React-based Gatsby has been adopted by thousands of teams to create e-commerce websites, developer blogs, portfolios, and&nbsp;more.  Gatsby is a robust framework t...'
---

 <figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*A3dBfabkynQMUZTqGQmDvw.png" /></figure><p>As one of the most popular “static site” generators, the React-based <a href="http://gatsbyjs.com/">Gatsby</a> has been adopted by thousands of teams to create e-commerce websites, developer blogs, portfolios, and more.</p><p>Gatsby is a robust framework that debunks the common misconception that static sites lack complexity or interactability. That’s why <a href="https://www.gatsbyjs.org/docs/testing/">testing your Gatsby project</a> is just as important as it is when building anything else — whether with unit testing, component testing, or end-to-end testing.</p><p><strong>With </strong><a href="https://docs.percy.io/docs/gatsby"><strong>Percy’s new Gatsby plugin</strong></a><strong>, it’s now easier than ever to test your Gatsby project from a visual standpoint too.</strong></p><p>When running alongside continuous deployments — with <a href="https://www.netlify.com/">Netlify</a> or Gatsby’s <a href="https://www.gatsbyjs.org/blog/2020-01-27-announcing-gatsby-builds-and-reports/">newly released Gatsby Builds </a>— Percy can provide teams with seamless and continuous visual testing. It works by generating UI screenshots of your project whenever you build your site and comparing them against baselines to see if anything has changed visually.</p><p><strong>In this tutorial, we’ll integrate visual testing into a Gatsby project, set up continuous deployments with Netlify, and do an end-to-end visual review.</strong></p><p>We’re going to set up an example Gatsby site, but you can easily adapt this tutorial to work for your own application.</p><p>Starting from scratch, install Gatsby CLI, and create a new project:</p><pre>$ npm install -g gatsby-cli</pre><pre>$ gatsby new gatsby-example</pre><p>We can now see a gatsby-example directory with all the assets you need to develop your Gatsby site.</p><p>Navigate to your directory and add gatsby to the dependencies of your package.json file by running:</p><pre>$ npm install gatsby-cli --save</pre><p>Compile your site by running:</p><pre>$ gatsby develop</pre><p>You can see the Gatsby starter site at <a href="http://localhost:8000/.">http://localhost:8000/</a>:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*se9ANmDsZonSGjPfaA_PRw.png" /></figure><p>Now we’re ready to add Percy for visual testing. <strong>👀</strong></p><h3>Installing Percy’s Gatsby plugin</h3><p>Percy’s Gatsby plugin is powered by <a href="https://docs.percy.io/docs/command-line-client">Percy CLI</a> and works by taking screenshots every time you build your site. By default, it takes snapshots of your /public directory, but you can configure it to match your setup or to ignore certain pages.</p><p>To get started, navigate to your directory and run:</p><pre>$ npm install --save @percy/agent gatsby-plugin-percy</pre><p>This may take a few minutes as we download all the dependencies needed to capture the DOM state of your pages and render screenshots. Once it’s finished installing, open your gatsby-config.js file and add &#39;gatsby-plugin-percy&#39; to the list of plugins. It should look something like this:</p><pre>module.exports = {<br>  siteMetadata: {<br>    title: `Gatsby Default Starter`,<br>    description: `Kick off your next, great Gatsby project with this default starter. This barebones starter ships with the main Gatsby configuration files you might need.`,<br>    author: `<a href="http://twitter.com/gatsbyjs">@gatsbyjs</a>`,<br>  },<br>  plugins: [<br>    `gatsby-plugin-react-helmet`,<br>    {<br>      resolve: `gatsby-source-filesystem`,<br>      options: {<br>        name: `images`,<br>        path: `${__dirname}/src/images`,<br>      },<br>    },<br>    `gatsby-transformer-sharp`,<br>    `gatsby-plugin-sharp`,<br>    `gatsby-plugin-percy`,<br>    {<br>      resolve: `gatsby-plugin-manifest`,<br>      options: {<br>        name: `gatsby-starter-default`,<br>        short_name: `starter`,<br>        start_url: `/`,<br>        background_color: `#663399`,<br>        theme_color: `#663399`,<br>        display: `minimal-ui`,<br>        icon: `src/images/gatsby-icon.png`, // This path is relative to the root of the site.<br>      },<br>    },<br>    // this (optional) plugin enables Progressive Web App + Offline functionality<br>    // To learn more, visit: <a href="https://gatsby.dev/offline">https://gatsby.dev/offline</a><br>    // `gatsby-plugin-offline`,<br>  ],<br>}</pre><p>Let’s run our first build locally to make sure everything is set up correctly.</p><h4>Running your first Percy build</h4><p>If you haven’t already, <a href="https://percy.io">sign up for a free Percy account</a>. Percy’s free plan includes unlimited projects, 10 users, and 5,000 snapshots each month.</p><p>Name your organization and create your first project. Percy projects correspond with the apps, sites, or component libraries you want to test.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*s_E0-NIwoRWOMq-u1K58GA.png" /></figure><p>Each has a project-specific API token that we’ll use to configure our local environment now, and our Netlify environment later.</p><p>Copy and set your PERCY_TOKEN in your local environment and run your first build:</p><pre># If you&#39;re using Windows:<br>$ set PERCY_TOKEN=&lt;your token here&gt;</pre><pre># Otherwise:<br>$ export PERCY_TOKEN=&lt;your token here&gt;</pre><pre>$ gatsby build</pre><p>This will compile your site, call the Percy plugin, and trigger Percy to render screenshots of all the pages located in your project’s /public directory.</p><p>Click the link in your terminal output to check out your screenshots:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*WYaKyiOflB7sdgLhruQF_g.png" /></figure><p>Notice that because this is your first build, there’s nothing to compare the snapshots to. The snapshots in this build will be the baselines for snapshots in subsequent builds.</p><p>Now that we’ve run our first build locally, let’s get our code into GitHub and get ready to connect Percy and Netlify.</p><h3>Setting up your GitHub repo</h3><p>Start by making a new GitHub repository for your example app.</p><p>After navigating to your directory, initialize it as a Git repo, add the files in your local repo, commit the files you’ve staged, and push them to your new repository.</p><pre>$ git init</pre><pre>$ git add .</pre><pre>$ git commit -m ‘First commit&#39;</pre><pre>$ git remote add origin: <a href="https://github.com/[username]/[repository].git">https://github.com/[name]/[repository].git</a></pre><pre>$ git push -u origin master</pre><p>Now that your code is on GitHub, head to your Percy project, select “Add integration,” and follow all the steps to install the <a href="https://docs.percy.io/docs/github">GitHub integration</a>. Once you’ve authorized GitHub, you need to link your Percy project with your GitHub repo.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*8mCPaERRRdw4FIHJLgTsuQ.png" /></figure><p>After you’ve installed Percy’s GitHub integration, your visual testing results and alerts will appear in your commits and pull request checks, making it easy to review changes. A pull request integration also provides Percy with better metadata when new builds are created and can help in selecting the <a href="https://docs.percy.io/docs/baseline-picking-logic">most accurate baseline</a> for pull request builds.</p><h3>Getting continuous deployments with Netlify</h3><p><a href="https://app.netlify.com/signup?_ga=2.122613195.1780329941.1581365581-925568841.1580406008">Sign up for a Netlify account</a> and select “New site from Git.” Once you’ve authorized Netlify and linked your example site repository, configure your settings and hit “Deploy site.” Alternatively, you can deploy directly from the README.md in your Gatsby starter GitHub repo. Either way, Netlify will immediately start deploying your site.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*bvMFU3V6gWLVVkMfahFhwA.png" /></figure><p>Next, let’s <a href="https://docs.percy.io/docs/netlify">connect Netlify with our Percy project</a>. Navigate to your Netlify dashboard, go to Settings &gt; Build &amp; deploy &gt; Environment &gt; Environment variables. Paste your PERCY_TOKEN, the API key we used earlier; you can find it in your Project settings.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*qOIDFYrlBjHLZ2rgFpa25Q.png" /></figure><p>Now that we’ve integrated everything, we’re ready to do our first end-to-end visual review.</p><h3>End-to-end visual review</h3><p>Let’s make a code change that will result in visual changes to our site, build our site, and review the changes in Percy.</p><p>For simplicity’s state, we’re going to make a small text change to our index.js file, changing line 11 in honor of our mascot 💜:</p><pre>import React from &quot;react&quot;<br>import { Link } from &quot;gatsby&quot;</pre><pre>import Layout from &quot;../components/layout&quot;<br>import Image from &quot;../components/image&quot;<br>import SEO from &quot;../components/seo&quot;</pre><pre>const IndexPage = () =&gt; (<br>  &lt;Layout&gt;<br>    &lt;SEO title=&quot;Home&quot; /&gt;<br><strong>    &lt;h1&gt;Hi porcupines&lt;/h1&gt;</strong><br>    &lt;p&gt;Welcome to your new Gatsby site.&lt;/p&gt;<br>    &lt;p&gt;Now go build something great.&lt;/p&gt;<br>    &lt;div style={{ maxWidth: `300px`, marginBottom: `1.45rem` }}&gt;<br>      &lt;Image /&gt;<br>    &lt;/div&gt;<br>    &lt;Link to=&quot;/page-2/&quot;&gt;Go to page 2&lt;/Link&gt;<br>  &lt;/Layout&gt;<br>)</pre><pre>export default IndexPage</pre><p>Commit those changes to a new branch and watch Netlify spin up a deploy preview, complete its various checks, and trigger Percy. Percy will render new screenshots for your compiled site and compare them against the snapshots from our first build.</p><p>Since there are visual changes, Percy will show up in your pull request as needing review:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*EY96mb_GnhOs-D0K7X0yCw.png" /></figure><p>Clicking “Details” will take you to the Percy UI where you can review the visual change:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*PiicBDjpxYTV8fCQjezbkQ.gif" /></figure><p>The red highlighting in the right panel represents the part of your page that has changed. Clicking that area (or pressing “d”) will toggle between the diff and the underlying screenshot so you can easily see what has changed.</p><p>Your pages have been rendered across different responsive widths and browsers to help detect regressions across those different environments.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*5liuFq4v6m4sxwBVGRqRkw.gif" /></figure><p>By default, Percy renders across Chrome and Firefox, both at 375px and 1280px. To configure custom widths, check <a href="https://docs.percy.io/docs/sdk-configuration">out our global @percy/agent config docs</a>.</p><h4>Reviewing visual changes</h4><p>With Percy, you can either Approve ✅ or Request changes 🙅‍♀️as well as leave comments 💬 on snapshots.</p><p>If you’re happy with your changes, you can approve individual snapshots or “Approve all” to signify that everything looks good. Alternatively, if the detected changes were unintentional or otherwise are not ready to be merged, marking them as “Changes requested” will block the build from being approved. This feature, coupled with snapshot comments, makes it easy for teams to collaborate and stay on the same page throughout visual reviews.</p><p>Since we meant to make this change, let’s hit “Approve.” Heading back over to our pull request, we’ll see that all our pull request check is green:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*XciagtGPPMcFi8HOw71r5g.png" /></figure><p>Congratulations on doing your first visual review! ✨</p><p>We hope this tutorial helped you get started with Percy for Gatsby and Netlify and gave you a glimpse into the powers fo visual testing.</p><p>We’re thrilled to make it easier to integrate Percy with Gatsby and to provide first-class support for Netlify. If you have questions or need help, don’t hesitate to reach out to support via our website chat or by emailing <a href="mailto:support@percy.io">support@percy.io</a>.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=7ad23f7b9228" width="1" height="1" alt=""><hr><p><a href="https://blog.percy.io/tutorial-visual-testing-for-gatsby-and-netlify-with-percy-7ad23f7b9228">Tutorial: Visual testing for Gatsby and Netlify with Percy</a> was originally published in <a href="https://blog.percy.io">Percy Blog</a> on Medium, where people are continuing the conversation by highlighting and responding to this story.</p>
