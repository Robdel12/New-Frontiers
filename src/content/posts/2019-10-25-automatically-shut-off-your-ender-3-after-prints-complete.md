---
layout: post
title: 'Automatically shut off your Ender 3 after prints complete'
date: 2019-10-25
excerpt: ' I recently have been running longer prints that sometimes finish in the middle of the night (or day when I’m not around). Sometimes these prints would finish at 2am and I would hate for the printer to be left on until I w...'
---

 <p>I recently have been running longer prints that sometimes finish in the middle of the night (or day when I’m not around). Sometimes these prints would finish at 2am and I would hate for the printer to be left on until I wake up in the morning.</p><p>So, I set out to automate turning the printer off after a print is finished. To do this I have the printer plugged into a <a href="https://www.amazon.com/gp/product/B07727D1VC/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&amp;psc=1">Meross smart plug</a> and the printer is controlled by Octoprint (running on a pi). Throughout this post, I’m assuming you have Octoprint already setup and working with your printer.</p><p>Octoprint allows you to configure <a href="https://docs.octoprint.org/en/master/events/index.html">events</a> that can run any system command. For me, I’m most comfortable in JavaScript. I’m going to run a JS script once Octoprint sends the “<em>PrintDone</em>” event.</p><h4>Controlling the smart plug</h4><p>First thing we need to do is make sure Node.js is installed on the pi. If not, you can install it by running:</p><pre>$ sudo apt-get update` <br>$ sudo apt-get install nodejs</pre><p>Once Node is installed, you can add the script that will turn the printer off. <a href="https://gist.github.com/Robdel12/60011235a0e1e3d8a99367bf9fcb388b">This is the function I wrote</a> to do this with a Meross smart plug. For me, I placed the contents of that GitHub gist in a <em>scripts</em> folder under the pi users root directory:</p><pre>$ cd ~/scripts<br>$ curl <a href="https://gist.githubusercontent.com/Robdel12/60011235a0e1e3d8a99367bf9fcb388b/raw/e3c730fe12d509705abd5118175400bd40413806/toggle-plug.js">https://gist.githubusercontent.com/Robdel12/60011235a0e1e3d8a99367bf9fcb388b/raw/e3c730fe12d509705abd5118175400bd40413806/toggle-plug.js</a> -o turn-off-plug.js</pre><p>Running the curl command will place a `turn-off-plug.js` file into the directory it was run in. You will need to know the IP address of the Meross plug. Once you find that (I use <a href="https://debookee.com/">debokee</a>), edit <em>turn-off-printer.js</em> to fill in your plugs IP:</p><pre>// Example usage:<br>// Comment these lines below out and add your plugs IP:<br>(async () =&gt; {<br> await toggleMerossPlug(“[IP_HERE]”, “off”);<br>})();</pre><p>The last thing that needs to be done to make that file work is installing the `<em>request</em>` dependency. First run `<em>npm init</em>` in <em>~/scripts</em> &amp; follow the prompts. After that run `<em>npm i -D request</em>`. Now you can test your script by running `<em>node ~/scripts/turn-off-plug.js</em>`! If that turns the plug off, everything works. 🎉</p><h4>Controlling the smart plug from Octoprint</h4><p>Now that we can control the plug (and the printer) from a node script, lets wire that up to Octoprint. We’ll use the `<em>PrintDone</em>` <a href="https://docs.octoprint.org/en/master/events/index.html">event</a> to run our node script. As it’s named, that event will fire once the print has finished up.</p><p>We will need to edit the `<em>config.yaml</em>` file Octoprint has. First cd into the `<em>.octoprint</em>` directory (`<em>$ cd ~/.octoprint</em>`) and add the following config:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/790a103933c577098be307227f0967a9/href">https://medium.com/media/790a103933c577098be307227f0967a9/href</a></iframe><p>Save the config file and restart the rasbperry pi. Now run a test print to verify everything works. I used the bed leveling gcode so its quick and easy to see if it works. 🎉</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=1ddb2dad33a0" width="1" height="1" alt="">
